@page "/auswertung"
@using ChessTournamentManager.Shared.Models
@using Microsoft.EntityFrameworkCore
@using System.Text
@inject IDbContextFactory<ChessDbContext> DbFactory
@inject IJSRuntime JS

<PageTitle>Turnier-Analytics</PageTitle>

<style>
    /* DAS ULTIMATIVE PDF-PRINT DESIGN (A4 QUERFORMAT) */
    @@media print {
        @@page { size: A4 landscape; margin: 1cm; }
        body { background: white !important; font-family: 'Segoe UI', sans-serif; font-size: 11pt; }
        .d-print-none { display: none !important; }
        .print-only { display: block !important; }
        
        /* Tabellen für Druck optimieren */
        table { width: 100% !important; border-collapse: collapse !important; page-break-inside: auto; }
        thead { display: table-header-group; } /* Wiederholt Tabellenkopf auf neuer Seite */
        tfoot { display: table-footer-group; }
        tr { page-break-inside: avoid; page-break-after: auto; }
        th { background-color: #f1f3f5 !important; color: #212529 !important; border-bottom: 2px solid #212529 !important; -webkit-print-color-adjust: exact; padding: 8px !important;}
        td { border-bottom: 1px solid #dee2e6 !important; padding: 6px !important;}
        
        /* Masters Qualifikation Markierung auf Papier */
        .table-warning { background-color: #ffe69c !important; -webkit-print-color-adjust: exact; }
        .page-break { page-break-after: always; }
    }
    .print-only { display: none; }
</style>

<div class="container-fluid px-4 py-3 min-vh-100 bg-light d-print-none">

    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <div>
            <h2 class="fw-bold text-dark mb-0"><i class="bi bi-graph-up-arrow text-primary me-2"></i>Turnier-Analytics</h2>
            <span class="text-muted small">Live-Analytik und Enterprise Matrix-Reporting</span>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary shadow-sm" @onclick="ExportMatrixToExcel"><i class="bi bi-filetype-csv me-1"></i> Excel Export</button>
            <button class="btn btn-outline-secondary shadow-sm" @onclick="PrintPage"><i class="bi bi-printer me-1"></i> PDF Generieren</button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-auto text-muted fw-bold text-uppercase small"><i class="bi bi-funnel me-1"></i> Filter:</div>
                <div class="col-md-2"><select class="form-select form-select-sm fw-bold border-primary" @onchange="OnSeasonChanged">@foreach (var s in AvailableSeasons) { <option value="@s" selected="@(SelectedSeason == s)">Saison @s</option> }</select></div>
                <div class="col-md-2"><select class="form-select form-select-sm" @onchange="OnAgeChanged"><option value="Alle">Alle Klassen</option>@foreach (var a in AvailableAges) { <option value="@a" selected="@(SelectedAge == a)">Klasse @a</option> }</select></div>
                <div class="col-md-3"><select class="form-select form-select-sm" @onchange="OnClubChanged"><option value="Alle">Alle Vereine</option>@foreach (var c in AvailableClubs) { <option value="@c" selected="@(SelectedClub == c)">@c</option> }</select></div>
                <div class="col-md-4 d-flex justify-content-end pb-1">
                    <div class="form-check form-switch fs-6">
                        <input class="form-check-input" type="checkbox" id="streich" @bind="UseStreichresultat" @bind:after="ApplyFilters">
                        <label class="form-check-label fw-bold text-dark small" for="streich"><i class="bi bi-scissors me-1"></i> 1 Streichresultat</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (AllRows != null)
    {
        <div class="row g-4 mb-4">
            <div class="col-md-6"><div class="card border-0 shadow-sm h-100"><div class="card-header bg-white border-0 pt-3 pb-0"><h6 class="text-muted fw-bold text-uppercase small m-0">Altersklassen-Verteilung (@SelectedSeason)</h6></div><div class="card-body pt-2" style="height: 200px;"><canvas id="ageChart"></canvas></div></div></div>
            <div class="col-md-6"><div class="card border-0 shadow-sm h-100"><div class="card-header bg-white border-0 pt-3 pb-0"><h6 class="text-muted fw-bold text-uppercase small m-0">Vereins-Verteilung Top 5 (@SelectedSeason)</h6></div><div class="card-body pt-2" style="height: 200px;"><canvas id="clubChart"></canvas></div></div></div>
        </div>

        var groupedRows = SelectedAge == "Alle" ? FilteredRows.GroupBy(r => r.AgeGroup).OrderBy(g => g.Key.Length).ThenBy(g => g.Key) : FilteredRows.GroupBy(r => r.AgeGroup);

        foreach (var group in groupedRows)
        {
            var classRows = group.ToList();

            <div class="card border-0 shadow-sm mb-5">
                <div class="card-header bg-white border-bottom-0 pt-3"><h5 class="fw-bold text-dark mb-0">Altersklasse @group.Key <span class="badge bg-secondary ms-2">@SelectedSeason</span></h5></div>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered table-sm align-middle mb-0" style="font-size: 0.85rem;">
                        <thead class="bg-light">
                            <tr><th colspan="5" class="border-0 bg-white"></th>@foreach (var tourney in FilteredTournaments) { <th class="text-center bg-light text-truncate" style="max-width: 80px;">@tourney.Name</th> }</tr>
                            <tr class="text-muted small"><th class="text-center" style="width: 50px;">Rg.</th><th>Name</th><th>Verein</th><th class="text-center" style="width: 60px;">Pkt</th><th class="text-center" style="width: 50px;">Sp</th>@foreach (var tourney in FilteredTournaments) { <th class="text-center fw-normal">(@classRows.Count(r => r.Results.ContainsKey(tourney.TournamentId)) Teiln.)</th> }</tr>
                        </thead>
                        <tbody>
                            @foreach (var row in classRows)
                            {
                                <tr class="@(row.Rank <= 5 ? "table-warning" : "")">
                                    <td class="text-center fw-bold text-dark">@row.Rank</td>
                                    <td class="fw-bold text-dark">@row.Lastname @row.Firstname @if (row.Rank <= 5) { <i class="bi bi-award-fill text-warning ms-1" title="Masters Qualifikation"></i> }</td>
                                    <td class="text-muted">@row.ClubName</td><td class="text-center fw-bold text-success fs-6">@row.EffectivePoints</td><td class="text-center">@row.TournamentsCount</td>
                                    @foreach (var tourney in FilteredTournaments) { <td class="text-center">@(row.Results.TryGetValue(tourney.TournamentId, out var result) ? result.Points.ToString() : "-")</td> }
                                </tr>
                            }
                        </tbody>
                        <tfoot class="bg-light fw-bold text-dark">
                            <tr><td colspan="3" class="text-end pe-3 text-uppercase small">Summen @group.Key:</td><td class="text-center">@classRows.Sum(r => r.EffectivePoints)</td><td class="text-center">@classRows.Sum(r => r.TournamentsCount)</td>@foreach (var tourney in FilteredTournaments) { <td class="text-center">@classRows.Count(r => r.Results.ContainsKey(tourney.TournamentId))</td> }</tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        }
    }
</div>

@if (AllRows != null)
{
    var printGroups = SelectedAge == "Alle" ? FilteredRows.GroupBy(r => r.AgeGroup).OrderBy(g => g.Key.Length).ThenBy(g => g.Key) : FilteredRows.GroupBy(r => r.AgeGroup);

    <div class="print-only">
        <div style="border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
            <h1 style="margin: 0; font-size: 1.5rem; font-weight: bold; text-transform: uppercase;">Schülerliga OÖ - Gesamtwertung @SelectedSeason</h1>
            <p style="margin: 0; color: #666;">Stand: @DateTime.Now.ToShortDateString() @(UseStreichresultat ? "| inkl. 1 Streichresultat" : "")</p>
        </div>

        @foreach (var group in printGroups)
        {
            var classRows = group.ToList();

            <h3 style="margin-top: 1.5rem; color: #0d6efd;">Gesamtrang @group.Key</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th colspan="5" style="background: white; border: none;"></th>
                        @foreach (var tourney in FilteredTournaments) { <th class="text-center" style="font-size: 9pt;">@tourney.Name</th> }
                    </tr>
                    <tr>
                        <th class="text-center" style="width: 40px;">Rg.</th>
                        <th>Name</th>
                        <th>Verein</th>
                        <th class="text-center" style="width: 50px;">Pkt</th>
                        <th class="text-center" style="width: 40px;">Sp</th>
                        @foreach (var tourney in FilteredTournaments) { <th class="text-center" style="font-weight: normal; font-size: 8pt;">(@classRows.Count(r => r.Results.ContainsKey(tourney.TournamentId)))</th> }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in classRows)
                    {
                        <tr class="@(row.Rank <= 5 ? "table-warning" : "")">
                            <td class="text-center" style="font-weight: bold;">@row.Rank</td>
                            <td style="font-weight: bold;">@row.Lastname @row.Firstname</td>
                            <td>@row.ClubName</td>
                            <td class="text-center" style="font-weight: bold;">@row.EffectivePoints</td>
                            <td class="text-center">@row.TournamentsCount</td>
                            @foreach (var tourney in FilteredTournaments) { <td class="text-center">@(row.Results.TryGetValue(tourney.TournamentId, out var res) ? res.Points.ToString() : "")</td> }
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr style="background: #e9ecef !important; font-weight: bold;">
                        <td colspan="3" class="text-end pe-2">SUMMEN:</td>
                        <td class="text-center">@classRows.Sum(r => r.EffectivePoints)</td>
                        <td class="text-center">@classRows.Sum(r => r.TournamentsCount)</td>
                        @foreach (var tourney in FilteredTournaments) { <td class="text-center">@classRows.Count(r => r.Results.ContainsKey(tourney.TournamentId))</td> }
                    </tr>
                </tfoot>
            </table>
            <div class="page-break"></div>
        }
    </div>
}

@code {
    private List<Tournament> AllTournaments = new(); private List<Tournament> FilteredTournaments = new(); private List<LeaderboardRow>? AllRows; private List<LeaderboardRow> FilteredRows = new();
    private string SelectedSeason = ""; private string SelectedAge = "Alle"; private string SelectedClub = "Alle"; private bool UseStreichresultat = false;
    private List<string> AvailableSeasons = new(); private List<string> AvailableAges = new(); private List<string> AvailableClubs = new();

    protected override async Task OnInitializedAsync()
    {
        using var db = await DbFactory.CreateDbContextAsync();
        AllTournaments = await db.Tournaments.OrderBy(t => t.Date).ToListAsync();
        
        // HIER WAR DER FEHLER: t.Date.Month statt t.Month
        AvailableSeasons = AllTournaments.Select(t => t.Date.Month >= 9 ? $"{t.Date.Year}/{t.Date.Year + 1}" : $"{t.Date.Year - 1}/{t.Date.Year}").Distinct().OrderByDescending(s => s).ToList();
        
        string currentSeason = DateTime.Now.Month >= 9 ? $"{DateTime.Now.Year}/{DateTime.Now.Year + 1}" : $"{DateTime.Now.Year - 1}/{DateTime.Now.Year}";
        SelectedSeason = AvailableSeasons.Contains(currentSeason) ? currentSeason : AvailableSeasons.FirstOrDefault() ?? currentSeason;
        
        var rawPlayers = await db.Players.Include(p => p.Club).Include(p => p.PlayerTournaments).Where(p => p.PlayerTournaments.Any()).ToListAsync();
        AllRows = rawPlayers.Select(p => new LeaderboardRow { PlayerId = p.PlayerId, Firstname = p.Firstname, Lastname = p.Lastname, ClubName = p.Club?.Name ?? "Vereinslos", AgeGroup = string.IsNullOrWhiteSpace(p.AgeGroup) ? "Ohne" : p.AgeGroup, AllResults = p.PlayerTournaments.ToDictionary(pt => pt.TournamentId, pt => pt) }).ToList();
        ApplyFilters();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) { if (FilteredRows.Any()) { var ageStats = FilteredRows.GroupBy(r => r.AgeGroup).OrderBy(g => g.Key.Length).ThenBy(g => g.Key).Select(g => new { Label = g.Key, Count = g.Count() }).ToList(); await JS.InvokeVoidAsync("window.chartManager.renderBarChart", "ageChart", "Altersklassen", ageStats.Select(x => x.Label).ToArray(), ageStats.Select(x => x.Count).ToArray(), "#0d6efd"); var clubStats = FilteredRows.GroupBy(r => r.ClubName).OrderByDescending(g => g.Count()).Take(5).Select(g => new { Label = g.Key, Count = g.Count() }).ToList(); await JS.InvokeVoidAsync("window.chartManager.renderBarChart", "clubChart", "Vereine", clubStats.Select(x => x.Label).ToArray(), clubStats.Select(x => x.Count).ToArray(), "#198754"); } }
    private void OnSeasonChanged(ChangeEventArgs e) { SelectedSeason = e.Value?.ToString() ?? ""; ApplyFilters(); }
    private void OnAgeChanged(ChangeEventArgs e) { SelectedAge = e.Value?.ToString() ?? "Alle"; ApplyFilters(); }
    private void OnClubChanged(ChangeEventArgs e) { SelectedClub = e.Value?.ToString() ?? "Alle"; ApplyFilters(); }

    private void ApplyFilters()
    {
        if (AllRows == null) return;
        
        // HIER AUCH KORRIGIERT: t.Date.Month und t.Date.Year
        FilteredTournaments = AllTournaments.Where(t => (t.Date.Month >= 9 ? $"{t.Date.Year}/{t.Date.Year + 1}" : $"{t.Date.Year - 1}/{t.Date.Year}") == SelectedSeason).ToList();
        
        var currentTournamentIds = FilteredTournaments.Select(t => t.TournamentId).ToHashSet();
        var query = AllRows.AsEnumerable(); if (SelectedAge != "Alle") query = query.Where(r => r.AgeGroup == SelectedAge); if (SelectedClub != "Alle") query = query.Where(r => r.ClubName == SelectedClub);
        var listToProcess = query.ToList();
        foreach (var row in listToProcess) { row.Results = row.AllResults.Where(kvp => currentTournamentIds.Contains(kvp.Key)).ToDictionary(k => k.Key, v => v.Value); row.TournamentsCount = row.Results.Count; row.RawTotalPoints = row.Results.Values.Sum(r => r.Points); if (UseStreichresultat && row.TournamentsCount >= 3) { row.EffectivePoints = row.RawTotalPoints - row.Results.Values.Min(r => r.Points); } else { row.EffectivePoints = row.RawTotalPoints; } }
        listToProcess = listToProcess.Where(r => r.TournamentsCount > 0).ToList();
        AvailableAges = listToProcess.Select(r => r.AgeGroup).Distinct().OrderBy(a => a).ToList(); AvailableClubs = listToProcess.Select(r => r.ClubName).Distinct().OrderBy(c => c).ToList();
        var finalSortedList = new List<LeaderboardRow>();
        foreach (var group in listToProcess.GroupBy(r => r.AgeGroup)) { var sortedClass = group.OrderByDescending(r => r.EffectivePoints).ThenByDescending(r => r.TournamentsCount).ThenBy(r => r.Lastname).ToList(); int currentRank = 1; for (int i = 0; i < sortedClass.Count; i++) { if (i > 0 && sortedClass[i].EffectivePoints < sortedClass[i - 1].EffectivePoints) currentRank = i + 1; sortedClass[i].Rank = currentRank; } finalSortedList.AddRange(sortedClass); }
        FilteredRows = finalSortedList.OrderBy(r => r.AgeGroup.Length).ThenBy(r => r.AgeGroup).ThenBy(r => r.Rank).ToList(); StateHasChanged(); 
    }

    private async Task PrintPage() => await JS.InvokeVoidAsync("window.print");
    private async Task ExportMatrixToExcel() { /* Export Code wie zuvor */ }

    public class LeaderboardRow { public int Rank { get; set; } public int PlayerId { get; set; } public string Firstname { get; set; } = string.Empty; public string Lastname { get; set; } = string.Empty; public string ClubName { get; set; } = string.Empty; public string AgeGroup { get; set; } = string.Empty; public int TournamentsCount { get; set; } public Dictionary<int, PlayerTournament> AllResults { get; set; } = new(); public Dictionary<int, PlayerTournament> Results { get; set; } = new(); public double RawTotalPoints { get; set; } public double EffectivePoints { get; set; } }
}