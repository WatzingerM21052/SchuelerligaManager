@page "/auswertung"
@using ChessTournamentManager.Shared.Models
@using Microsoft.EntityFrameworkCore
@using System.Text
@inject IDbContextFactory<ChessDbContext> DbFactory
@inject IJSRuntime JS

<PageTitle>SL-Manager - Auswertung</PageTitle>

<div class="container-fluid px-4 py-3 min-vh-100 bg-light">

    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <div>
            <h2 class="fw-bold text-dark mb-0"><i class="bi bi-graph-up-arrow text-primary me-2"></i>Turnier-Analytics</h2>
            <span class="text-muted small">Live-Analytik und professioneller PDF-Generator</span>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success shadow-sm fw-bold" @onclick="ExportMatrixToExcel"><i class="bi bi-file-earmark-excel-fill me-1"></i> Excel Export</button>
            <button class="btn btn-primary shadow-sm fw-bold" @onclick="GenerateProfessionalPdf"><i class="bi bi-file-pdf-fill me-1"></i> PDF Generieren</button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-auto text-muted fw-bold text-uppercase small"><i class="bi bi-funnel me-1"></i> Filter:</div>
                <div class="col-md-2"><select class="form-select form-select-sm fw-bold border-primary" @onchange="OnSeasonChanged">@foreach (var s in AvailableSeasons) { <option value="@s" selected="@(SelectedSeason == s)">Saison @s</option> }</select></div>
                <div class="col-md-2"><select class="form-select form-select-sm" @onchange="OnAgeChanged"><option value="Alle">Alle Klassen</option>@foreach (var a in AvailableAges) { <option value="@a" selected="@(SelectedAge == a)">Klasse @a</option> }</select></div>
                <div class="col-md-3"><select class="form-select form-select-sm" @onchange="OnClubChanged"><option value="Alle">Alle Vereine</option>@foreach (var c in AvailableClubs) { <option value="@c" selected="@(SelectedClub == c)">@c</option> }</select></div>
                <div class="col-md-4 d-flex justify-content-end pb-1">
                    <div class="form-check form-switch fs-6">
                        <input class="form-check-input" type="checkbox" id="bestof4" @bind="UseBestOf4" @bind:after="ApplyFilters">
                        <label class="form-check-label fw-bold text-dark small" for="bestof4"><i class="bi bi-trophy me-1"></i> Nur beste 4 Runden werten</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (AllRows != null)
    {
        <div class="row g-4 mb-4">
            <div class="col-md-6"><div class="card border-0 shadow-sm h-100"><div class="card-header bg-white border-0 pt-3 pb-0"><h6 class="text-muted fw-bold text-uppercase small m-0">Altersklassen-Verteilung (@SelectedSeason)</h6></div><div class="card-body pt-2" style="height: 200px;"><canvas id="ageChart"></canvas></div></div></div>
            <div class="col-md-6"><div class="card border-0 shadow-sm h-100"><div class="card-header bg-white border-0 pt-3 pb-0"><h6 class="text-muted fw-bold text-uppercase small m-0">Vereins-Verteilung Top 5 (@SelectedSeason)</h6></div><div class="card-body pt-2" style="height: 200px;"><canvas id="clubChart"></canvas></div></div></div>
        </div>

        var groupedRows = SelectedAge == "Alle" ? FilteredRows.GroupBy(r => r.AgeGroup).OrderBy(g => g.Key.Length).ThenBy(g => g.Key) : FilteredRows.GroupBy(r => r.AgeGroup);

        foreach (var group in groupedRows)
        {
            var classRows = group.ToList();

            <div class="card border-0 shadow-sm mb-5">
                <div class="card-header bg-dark text-white border-bottom-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0"><i class="bi bi-diagram-3-fill me-2 text-warning"></i>Klasse @group.Key</h5>
                    <span class="badge bg-light text-dark fs-6">@classRows.Count Spieler</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                        <thead class="bg-light">
                            <tr class="text-muted text-uppercase small" style="border-bottom: 2px solid #dee2e6;">
                                <th class="text-center" style="width: 80px;">Rang</th>
                                <th>Name</th>
                                <th>Verein</th>
                                <th class="text-center" style="width: 70px;">Pkt.</th>
                                <th class="text-center" style="width: 60px;">Spiele</th>
                                @foreach (var tourney in FilteredTournaments) { <th class="text-center bg-white text-dark fw-bold border-start border-end" style="width: 120px;" title="@tourney.Name">@Truncate(tourney.Name, 15)<br/><span class="fw-normal text-muted" style="font-size: 0.7rem;">(Platzierung)</span></th> }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in classRows)
                            {
                                <tr>
                                    <td class="text-center fw-bold text-dark fs-6">
                                        @if (row.Rank == 1) { <span>1. <i class="bi bi-trophy-fill text-warning ms-1" title="Gold"></i></span> }
                                        else if (row.Rank == 2) { <span>2. <i class="bi bi-trophy-fill text-secondary ms-1" title="Silber"></i></span> }
                                        else if (row.Rank == 3) { <span>3. <i class="bi bi-trophy-fill text-danger ms-1" title="Bronze"></i></span> }
                                        else { <span>@row.Rank.</span> }
                                    </td>
                                    <td class="fw-bold text-dark">@row.Lastname @row.Firstname</td>
                                    <td class="text-muted small">@row.ClubName</td>
                                    <td class="text-center fw-bold text-success fs-6">@row.EffectivePoints</td>
                                    <td class="text-center text-muted">@row.TournamentsCount</td>
                                    @foreach (var tourney in FilteredTournaments) 
                                    { 
                                        <td class="text-center border-start border-end @(row.Results.ContainsKey(tourney.TournamentId) ? "bg-light fw-bold" : "text-muted")">
                                            @(row.Results.TryGetValue(tourney.TournamentId, out var result) ? result.Rank.ToString() + "." : "-")
                                        </td> 
                                    }
                                </tr>
                            }
                        </tbody>
                        <tfoot class="bg-light fw-bold text-dark border-top">
                            <tr class="small text-muted">
                                <td colspan="3" class="text-end pe-3 text-uppercase">Summen:</td>
                                <td class="text-center text-dark fs-6">@classRows.Sum(r => r.EffectivePoints) Pkt.</td>
                                <td class="text-center text-dark fs-6">@classRows.Sum(r => r.TournamentsCount) Sp.</td>
                                @foreach (var tourney in FilteredTournaments) { <td class="text-center text-dark border-start border-end">@classRows.Count(r => r.Results.ContainsKey(tourney.TournamentId)) Teiln.</td> }
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<Tournament> AllTournaments = new(); private List<Tournament> FilteredTournaments = new(); private List<LeaderboardRow>? AllRows; private List<LeaderboardRow> FilteredRows = new();
    private string SelectedSeason = ""; private string SelectedAge = "Alle"; private string SelectedClub = "Alle"; 
    
    // NEU: UMBENANNT ZU "UseBestOf4"
    private bool UseBestOf4 = false;

    private List<string> AvailableSeasons = new(); private List<string> AvailableAges = new(); private List<string> AvailableClubs = new();

    protected override async Task OnInitializedAsync()
    {
        using var db = await DbFactory.CreateDbContextAsync();
        AllTournaments = await db.Tournaments.OrderBy(t => t.Date).ToListAsync();
        AvailableSeasons = AllTournaments.Select(t => t.Date.Month >= 9 ? $"{t.Date.Year}/{t.Date.Year + 1}" : $"{t.Date.Year - 1}/{t.Date.Year}").Distinct().OrderByDescending(s => s).ToList();
        string currentSeason = DateTime.Now.Month >= 9 ? $"{DateTime.Now.Year}/{DateTime.Now.Year + 1}" : $"{DateTime.Now.Year - 1}/{DateTime.Now.Year}";
        SelectedSeason = AvailableSeasons.Contains(currentSeason) ? currentSeason : AvailableSeasons.FirstOrDefault() ?? currentSeason;
        
        var rawPlayers = await db.Players.Include(p => p.Club).Include(p => p.PlayerTournaments).Where(p => p.PlayerTournaments.Any()).ToListAsync();
        AllRows = rawPlayers.Select(p => new LeaderboardRow { PlayerId = p.PlayerId, Firstname = p.Firstname, Lastname = p.Lastname, ClubName = p.Club?.Name ?? "Vereinslos", AgeGroup = string.IsNullOrWhiteSpace(p.AgeGroup) ? "Ohne" : p.AgeGroup, AllResults = p.PlayerTournaments.ToDictionary(pt => pt.TournamentId, pt => pt) }).ToList();
        ApplyFilters();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) { if (FilteredRows.Any()) { var ageStats = FilteredRows.GroupBy(r => r.AgeGroup).OrderBy(g => g.Key.Length).ThenBy(g => g.Key).Select(g => new { Label = g.Key, Count = g.Count() }).ToList(); await JS.InvokeVoidAsync("window.chartManager.renderBarChart", "ageChart", "Altersklassen", ageStats.Select(x => x.Label).ToArray(), ageStats.Select(x => x.Count).ToArray(), "#0d6efd"); var clubStats = FilteredRows.GroupBy(r => r.ClubName).OrderByDescending(g => g.Count()).Take(5).Select(g => new { Label = g.Key, Count = g.Count() }).ToList(); await JS.InvokeVoidAsync("window.chartManager.renderBarChart", "clubChart", "Vereine", clubStats.Select(x => x.Label).ToArray(), clubStats.Select(x => x.Count).ToArray(), "#198754"); } }
    private void OnSeasonChanged(ChangeEventArgs e) { SelectedSeason = e.Value?.ToString() ?? ""; ApplyFilters(); }
    private void OnAgeChanged(ChangeEventArgs e) { SelectedAge = e.Value?.ToString() ?? "Alle"; ApplyFilters(); }
    private void OnClubChanged(ChangeEventArgs e) { SelectedClub = e.Value?.ToString() ?? "Alle"; ApplyFilters(); }

    private void ApplyFilters()
    {
        if (AllRows == null) return;
        FilteredTournaments = AllTournaments.Where(t => (t.Date.Month >= 9 ? $"{t.Date.Year}/{t.Date.Year + 1}" : $"{t.Date.Year - 1}/{t.Date.Year}") == SelectedSeason).ToList();
        var currentTournamentIds = FilteredTournaments.Select(t => t.TournamentId).ToHashSet();
        var query = AllRows.AsEnumerable(); if (SelectedAge != "Alle") query = query.Where(r => r.AgeGroup == SelectedAge); if (SelectedClub != "Alle") query = query.Where(r => r.ClubName == SelectedClub);
        var listToProcess = query.ToList();
        
        foreach (var row in listToProcess) 
        { 
            row.Results = row.AllResults.Where(kvp => currentTournamentIds.Contains(kvp.Key)).ToDictionary(k => k.Key, v => v.Value); 
            row.TournamentsCount = row.Results.Count; 
            row.RawTotalPoints = row.Results.Values.Sum(r => r.Points); 

            // DIE NEUE "BEST-OF-4" LOGIK
            // Wenn der Schalter AN ist und der Spieler MEHR als 4 Runden hat, nehme nur die besten 4 Punkte
            if (UseBestOf4 && row.TournamentsCount > 4) 
            { 
                row.EffectivePoints = row.Results.Values.OrderByDescending(r => r.Points).Take(4).Sum(r => r.Points); 
            } 
            else 
            { 
                row.EffectivePoints = row.RawTotalPoints; 
            } 
        }

        listToProcess = listToProcess.Where(r => r.TournamentsCount > 0).ToList();
        AvailableAges = listToProcess.Select(r => r.AgeGroup).Distinct().OrderBy(a => a).ToList(); AvailableClubs = listToProcess.Select(r => r.ClubName).Distinct().OrderBy(c => c).ToList();
        var finalSortedList = new List<LeaderboardRow>();
        foreach (var group in listToProcess.GroupBy(r => r.AgeGroup)) { var sortedClass = group.OrderByDescending(r => r.EffectivePoints).ThenByDescending(r => r.TournamentsCount).ThenBy(r => r.Lastname).ToList(); int currentRank = 1; for (int i = 0; i < sortedClass.Count; i++) { if (i > 0 && sortedClass[i].EffectivePoints < sortedClass[i - 1].EffectivePoints) currentRank = i + 1; sortedClass[i].Rank = currentRank; } finalSortedList.AddRange(sortedClass); }
        FilteredRows = finalSortedList.OrderBy(r => r.AgeGroup.Length).ThenBy(r => r.AgeGroup).ThenBy(r => r.Rank).ToList(); StateHasChanged(); 
    }

    private string Truncate(string value, int maxChars) { return value.Length <= maxChars ? value : value.Substring(0, maxChars) + "..."; }

    private async Task GenerateProfessionalPdf()
    {
        var tournamentsData = FilteredTournaments.Select(t => new { name = Truncate(t.Name, 12) }).ToList();
        var printGroups = SelectedAge == "Alle" ? FilteredRows.GroupBy(r => r.AgeGroup).OrderBy(g => g.Key.Length).ThenBy(g => g.Key) : FilteredRows.GroupBy(r => r.AgeGroup);
        var groupsData = printGroups.Select(g => new { groupName = g.Key, rows = g.Select(r => new { rank = r.Rank, name = $"{r.Lastname} {r.Firstname}", club = string.IsNullOrWhiteSpace(r.ClubName) || r.ClubName == "Vereinslos" ? "-" : r.ClubName, points = r.EffectivePoints, games = r.TournamentsCount, results = FilteredTournaments.Select(t => r.Results.TryGetValue(t.TournamentId, out var res) ? $"{res.Rank}." : "-").ToList() }).ToList() }).ToList();
        
        // Den BestOf4 Parameter an JS schicken fÃ¼r den Text
        await JS.InvokeVoidAsync("window.pdfManager.generatePdf", SelectedSeason, UseBestOf4, tournamentsData, groupsData);
    }

    private async Task ExportMatrixToExcel()
    {
        var sb = new StringBuilder();
        sb.AppendLine($"Schuelerliga OOe - Gesamtwertung Saison {SelectedSeason}");
        sb.AppendLine($"Stand: {DateTime.Now.ToShortDateString()} {(UseBestOf4 ? "(Wertung: Beste 4 Runden)" : "")}");
        sb.AppendLine();
        var printGroups = SelectedAge == "Alle" ? FilteredRows.GroupBy(r => r.AgeGroup).OrderBy(g => g.Key.Length).ThenBy(g => g.Key) : FilteredRows.GroupBy(r => r.AgeGroup);
        foreach (var group in printGroups)
        {
            var classRows = group.ToList();
            sb.AppendLine($"ALTERSKLASSE {group.Key}");
            sb.Append("Rang;Name;Verein;Punkte Gesamt;Anz. Turniere");
            foreach (var t in FilteredTournaments) { sb.Append($";{t.Name} (Platz)"); }
            sb.AppendLine();
            foreach (var row in classRows)
            {
                sb.Append($"{row.Rank};{row.Lastname} {row.Firstname};{row.ClubName};{row.EffectivePoints};{row.TournamentsCount}");
                foreach (var t in FilteredTournaments) { sb.Append($";{(row.Results.TryGetValue(t.TournamentId, out var res) ? res.Rank.ToString() : "")}"); }
                sb.AppendLine();
            }
            sb.AppendLine();
        }
        var bytes = Encoding.UTF8.GetPreamble().Concat(Encoding.UTF8.GetBytes(sb.ToString())).ToArray();
        await JS.InvokeVoidAsync("window.downloadBinaryFile", $"Matrix_Saison_{SelectedSeason.Replace("/", "_")}.csv", Convert.ToBase64String(bytes));
    }

    public class LeaderboardRow { public int Rank { get; set; } public int PlayerId { get; set; } public string Firstname { get; set; } = string.Empty; public string Lastname { get; set; } = string.Empty; public string ClubName { get; set; } = string.Empty; public string AgeGroup { get; set; } = string.Empty; public int TournamentsCount { get; set; } public Dictionary<int, PlayerTournament> AllResults { get; set; } = new(); public Dictionary<int, PlayerTournament> Results { get; set; } = new(); public double RawTotalPoints { get; set; } public double EffectivePoints { get; set; } }
}