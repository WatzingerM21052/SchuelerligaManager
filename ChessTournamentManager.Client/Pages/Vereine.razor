@page "/vereine"
@using ChessTournamentManager.Shared.Models
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ChessDbContext> DbFactory
@inject NavigationManager NavManager

<PageTitle>Vereine</PageTitle>

<div class="container-fluid px-4 py-3 min-vh-100 bg-light">
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <div>
            <h2 class="fw-bold text-dark mb-0"><i class="bi bi-buildings text-primary me-2"></i>Vereine</h2>
            <span class="text-muted small">Übersicht aller Schachvereine und ihrer Mitglieder</span>
        </div>
        <button class="btn btn-primary shadow-sm" @onclick="OpenAddModal"><i class="bi bi-plus-lg me-1"></i> Neuer Verein</button>
    </div>

    @if (AllClubs == null)
    {
        <div class="d-flex justify-content-center mt-5"><div class="spinner-border text-primary"></div></div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var club in AllClubs.OrderBy(c => c.Name))
            {
                <div class="col-md-4 col-sm-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title fw-bold text-dark mb-0">@club.Name</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light border" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                                        <li><button class="dropdown-item" @onclick="() => OpenEditModal(club)"><i class="bi bi-pencil me-2"></i> Umbenennen</button></li>
                                        <li><button class="dropdown-item text-danger" @onclick="() => OpenDeleteModal(club)"><i class="bi bi-trash me-2"></i> Löschen</button></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="d-flex align-items-center text-muted small mb-3">
                                <i class="bi bi-people-fill me-2 fs-5"></i> 
                                <span class="fw-bold fs-6 me-1">@(club.Players?.Count ?? 0)</span> registrierte Spieler
                            </div>

                            <button class="btn btn-outline-primary btn-sm w-100 fw-bold" @onclick="() => OpenPlayersModal(club)">
                                <i class="bi bi-list-ul me-1"></i> Mitglieder anzeigen
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (IsPlayersModalOpen && SelectedClub != null)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-white border-bottom-0 pb-0">
                    <div>
                        <h5 class="modal-title fw-bold text-dark mb-0">Mitglieder: @SelectedClub.Name</h5>
                        <span class="text-muted small">Klicke auf einen Spieler, um sein Profil zu bearbeiten.</span>
                    </div>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body bg-light">
                    @if (SelectedClub.Players != null && SelectedClub.Players.Any())
                    {
                        <div class="list-group shadow-sm">
                            @foreach (var player in SelectedClub.Players.OrderBy(p => p.Lastname))
                            {
                                <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3" @onclick="() => NavigateToPlayer(player.PlayerId)">
                                    <div>
                                        <span class="fw-bold text-dark fs-6">@player.Lastname @player.Firstname</span>
                                        @if (!string.IsNullOrWhiteSpace(player.AgeGroup))
                                        {
                                            <span class="badge bg-light text-dark border ms-2">@player.AgeGroup</span>
                                        }
                                    </div>
                                    <div class="d-flex align-items-center text-muted">
                                        <span class="small me-3">Elo: @(player.Elo?.ToString() ?? "-")</span>
                                        <i class="bi bi-box-arrow-up-right text-primary"></i>
                                    </div>
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-secondary border-0 text-center mb-0">Keine Spieler für diesen Verein gefunden.</div>
                    }
                </div>
                <div class="modal-footer border-top-0">
                    <button class="btn btn-secondary px-4 fw-bold" @onclick="CloseModals">Schließen</button>
                </div>
            </div>
        </div>
    </div>
}

@if (IsEditModalOpen && EditingClub != null)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">@(EditingClub.ClubId == 0 ? "Neuen Verein anlegen" : "Verein umbenennen")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label text-muted small">Vereinsname</label>
                    <input type="text" class="form-control" @bind="EditingClub.Name" />
                </div>
                <div class="modal-footer border-top-0">
                    <button class="btn btn-secondary" @onclick="CloseModals">Abbrechen</button>
                    <button class="btn btn-primary" @onclick="SaveClub"><i class="bi bi-save me-1"></i> Speichern</button>
                </div>
            </div>
        </div>
    </div>
}

@if (IsDeleteModalOpen && ClubToDelete != null)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header bg-danger text-white border-0">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Verein löschen</h5>
                </div>
                <div class="modal-body">
                    <p>Möchtest du den Verein <strong>"@ClubToDelete.Name"</strong> unwiderruflich löschen?</p>
                    <p class="text-danger small">Hinweis: Die Spieler des Vereins werden nicht gelöscht, sie werden lediglich als "vereinslos" markiert.</p>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-secondary" @onclick="CloseModals">Abbrechen</button>
                    <button class="btn btn-danger" @onclick="DeleteClub">Ja, löschen</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Club>? AllClubs;
    
    private bool IsEditModalOpen = false;
    private bool IsDeleteModalOpen = false;
    private bool IsPlayersModalOpen = false;

    private Club? EditingClub;
    private Club? ClubToDelete;
    private Club? SelectedClub;

    protected override async Task OnInitializedAsync()
    {
        await LoadClubs();
    }

    private async Task LoadClubs()
    {
        using var db = await DbFactory.CreateDbContextAsync();
        // Läd die Vereine INKLUSIVE der verbundenen Spielerliste!
        AllClubs = await db.Clubs.Include(c => c.Players).ToListAsync();
    }

    // --- DIE NEUE WEITERLEITUNGS-FUNKTION ---
    private void NavigateToPlayer(int playerId)
    {
        // Wir senden den Nutzer an die Spieler-Seite und hängen die ID als Geheimcode an
        NavManager.NavigateTo($"/spieler?editPlayerId={playerId}");
    }

    // --- MODAL STEUERUNG ---
    private void OpenPlayersModal(Club c) { SelectedClub = c; IsPlayersModalOpen = true; }
    private void OpenAddModal() { EditingClub = new Club(); IsEditModalOpen = true; }
    private void OpenEditModal(Club c) { EditingClub = new Club { ClubId = c.ClubId, Name = c.Name }; IsEditModalOpen = true; }
    private void OpenDeleteModal(Club c) { ClubToDelete = c; IsDeleteModalOpen = true; }
    private void CloseModals() { IsEditModalOpen = false; IsDeleteModalOpen = false; IsPlayersModalOpen = false; EditingClub = null; ClubToDelete = null; SelectedClub = null; }

    // --- DATENBANK OPERATIONEN ---
    private async Task SaveClub()
    {
        if (EditingClub == null || string.IsNullOrWhiteSpace(EditingClub.Name)) return;

        using var db = await DbFactory.CreateDbContextAsync();
        if (EditingClub.ClubId == 0)
        {
            db.Clubs.Add(EditingClub);
        }
        else
        {
            var dbC = await db.Clubs.FindAsync(EditingClub.ClubId);
            if (dbC != null)
            {
                dbC.Name = EditingClub.Name;
                db.Clubs.Update(dbC);
            }
        }
        await db.SaveChangesAsync();
        await LoadClubs();
        CloseModals();
    }

    private async Task DeleteClub()
    {
        if (ClubToDelete == null) return;

        using var db = await DbFactory.CreateDbContextAsync();
        var dbC = await db.Clubs.Include(c => c.Players).FirstOrDefaultAsync(c => c.ClubId == ClubToDelete.ClubId);
        if (dbC != null)
        {
            // Setzt alle Spieler des Vereins auf "vereinslos"
            foreach (var player in dbC.Players)
            {
                player.ClubId = null;
            }
            db.Clubs.Remove(dbC);
            await db.SaveChangesAsync();
        }
        await LoadClubs();
        CloseModals();
    }
}