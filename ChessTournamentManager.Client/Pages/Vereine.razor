@page "/vereine"
@using ChessTournamentManager.Shared.Models
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ChessDbContext> DbFactory
@inject NavigationManager NavManager

<PageTitle>Vereins-Management</PageTitle>

<div class="container-fluid px-4 py-3 min-vh-100 bg-light">
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <div>
            <h2 class="fw-bold text-dark mb-0"><i class="bi bi-buildings text-primary me-2"></i>Vereins-Datenbank</h2>
            <span class="text-muted small">Verwaltung der teilnehmenden Schachvereine</span>
        </div>
        <button class="btn btn-primary shadow-sm" @onclick="OpenAddModal"><i class="bi bi-plus-lg me-1"></i> Neuer
            Verein</button>
    </div>

    @if (AllClubs == null)
    {
        <div class="d-flex justify-content-center mt-5">
            <div class="spinner-border text-primary"></div>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-muted small text-uppercase">
                        <tr>
                            <th class="ps-4">Vereinsname</th>
                            <th class="text-center">Mitglieder im System</th>
                            <th class="text-end pe-4">Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var club in AllClubs.OrderBy(c => c.Name))
                        {
                            <tr>
                                <td class="ps-4 fw-bold text-dark">@club.Name</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-info" @onclick="() => OpenPlayerListModal(club)"><i
                                            class="bi bi-people me-1"></i> @club.Players.Count Spieler</button>
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light border me-1" @onclick="() => OpenEditModal(club)"><i
                                            class="bi bi-pencil"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => OpenDeleteModal(club)"><i
                                            class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@if (IsPlayerListModalOpen && SelectedClub != null)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title fw-bold">Mitglieder in "@SelectedClub.Name"</h5><button type="button"
                        class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body p-0">
                    @if (!SelectedClub.Players.Any())
                    {
                        <p class="text-muted text-center p-3">Keine Spieler.</p>
                    }
                    else
                    {

                <div class="list-group list-group-flush">@foreach (var player in SelectedClub.Players.OrderBy(p
                                        => p.Lastname)) {
                                <button
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    @onclick="() => NavigateToPlayer(player.PlayerId)"><span
                                        class="text-dark fw-bold">@player.Lastname <span
                                            class="fw-normal text-muted">@player.Firstname</span></span><i
                                        class="bi bi-box-arrow-up-right text-primary"></i></button>
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer border-top-0"><button class="btn btn-secondary"
                        @onclick="CloseModals">Schließen</button></div>
            </div>
        </div>
    </div>
}

@if (IsEditModalOpen && EditingClub != null)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">@(EditingClub.ClubId == 0 ? "Neuen Verein anlegen" : "Verein                    bearbeiten")</h5><button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body"><label class="form-label text-muted small">Name</label><input type="text"
                        class="form-control" @bind="EditingClub.Name" /></div>
                <div class="modal-footer border-top-0"><button class="btn btn-secondary"
                        @onclick="CloseModals">Abbrechen</button><button class="btn btn-primary" @onclick="SaveClub"><i
                            class="bi bi-save me-1"></i> Speichern</button></div>
            </div>
        </div>
    </div>
}

@if (IsDeleteModalOpen && ClubToDelete != null)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header bg-danger text-white border-0">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Löschen</h5>
                </div>
                <div class="modal-body">
                    <p>Verein <strong>"@ClubToDelete.Name"</strong> löschen?</p>
                </div>
                <div class="modal-footer border-0"><button class="btn btn-secondary"
                        @onclick="CloseModals">Abbrechen</button><button class="btn btn-danger"
                        @onclick="DeleteClub">Löschen</button></div>
            </div>
        </div>
    </div>
}

@code {
    private List<Club>? AllClubs; private bool IsEditModalOpen = false; private bool IsDeleteModalOpen = false; private bool
    IsPlayerListModalOpen = false; private Club? EditingClub; private Club? ClubToDelete; private Club? SelectedClub;
    protected override async Task OnInitializedAsync() => await LoadClubs();
    private async Task LoadClubs()
    {
        using var db = await DbFactory.CreateDbContextAsync(); AllClubs = await
        db.Clubs.Include(c => c.Players).ToListAsync();
    }
    private void OpenAddModal() { EditingClub = new Club(); IsEditModalOpen = true; }
    private void OpenEditModal(Club club)
    {
        EditingClub = new Club
        {
            ClubId = club.ClubId,
            Name = club.Name,
            Players =
        club.Players
        }; IsEditModalOpen = true;
    }
    private void OpenDeleteModal(Club club) { ClubToDelete = club; IsDeleteModalOpen = true; }
    private void OpenPlayerListModal(Club club) { SelectedClub = club; IsPlayerListModalOpen = true; }
    private void NavigateToPlayer(int playerId) => NavManager.NavigateTo($"/spieler?editPlayerId={playerId}");
    private void CloseModals()
    {
        IsEditModalOpen = false; IsDeleteModalOpen = false; IsPlayerListModalOpen = false;
        EditingClub = null; ClubToDelete = null; SelectedClub = null;
    }
    private async Task SaveClub()
    {
        if (EditingClub == null || string.IsNullOrWhiteSpace(EditingClub.Name)) return; using
        var db = await DbFactory.CreateDbContextAsync(); if (EditingClub.ClubId == 0) db.Clubs.Add(EditingClub);
        else
        {
            var
            dbClub = await db.Clubs.FindAsync(EditingClub.ClubId); if (dbClub != null)
            {
                dbClub.Name = EditingClub.Name;
                db.Clubs.Update(dbClub);
            }
        }
        await db.SaveChangesAsync(); await LoadClubs(); CloseModals();
    }
    private async Task DeleteClub()
    {
        if (ClubToDelete == null) return; using var db = await
        DbFactory.CreateDbContextAsync(); var dbClub = await db.Clubs.Include(c => c.Players).FirstOrDefaultAsync(c => c.ClubId
        == ClubToDelete.ClubId); if (dbClub != null)
        {
            foreach (var player in dbClub.Players) player.ClubId = null;
            db.Clubs.Remove(dbClub); await db.SaveChangesAsync();
        }
        await LoadClubs(); CloseModals();
    }
}